# 标定
在正式运行前，在具有一定交通量的一段时间内，运行标定过程。
<br>
标定过程将得到：**车道线方程，抛洒物检测有效片区，应急车道编号**。
<br>

# note
以下关于车道线的拟合暂定为用固定a2系数，使用四分位特征轨迹点进行拟合。<br>
车道线将不再用于确定cell等功能。<br>
cell将直接根据y坐标确定。<br>
横向速度将直接根据x计算。<br>

# clb.yml格式
range:
    start: 200
    len: 200
    end: 0
lanes:
  1:
    emgc: False
    vDir:
      x: 1
      y: -1
    coef: [1, 2, 3]
    cells: [True, True, True, True]

# 车道线计算分析
**车道线计算是为了划分元胞。**暂无其他用途<br>
从xy散点图中可以看出，5-8lane的轨迹长度更长，能体现出更明显的二次函数性质，而1-4车道则没办法体现出明显的二次函数性质。如果直接对各个lane独立地去拟合出车道中心线的二次函数，会导致1-4号车道拟合的结果更像是一个一次函数，这与实际情况不符，并且不能与5-8号车道的曲率保持一致。
<br>
<p>
<img
src="../draw/trajectory.png"
alt="轨迹坐标"
title="轨迹坐标"
width="100%"
>
</p>
基于此分析，应当先对远处的5-8号，更准确的说采用具有最长轨迹距离的8号车道，先进行二次函数拟合，得到最明显，最贴合实际道路曲率的二次函数系数。之后固定二次函数的x^2和x的系数，让这样的二次函数曲线系去拟合其他车道，从而1-8车道得到不同的截距。
<br>
上述分析会发现，我们在预热标定阶段，也需要对<br><s>各个车道上所有车辆的行驶距离进行记录,</s><br>
<s>找到哪个车道的y值变化范围最大,</s>(因为考虑可能y值变化大的是直的)<br>
**找到哪个车道最大最小y值连线的斜率绝对值最大，**<br>
从而找到哪个lane具有最长的，二次函数最明显的特征。
（上述原理未及时更新2023.12.19）

### 拟合思路记录
1. 固定a21系数，拟合各车道的常数项b参数。发现这样只能上下动车道线，但水平方向没有移动，不对劲。
左为四分点拟合，右为所有点拟合。
<p>
<img
src="./images/LanePolyA21Frozen.png"
alt="四分点拟合"
title="四分点拟合"
width="50%"

<img
src="./images/LanePolyA21Frozen-AllPoints.png"
alt="所有点拟合"
title="所有点拟合"
width="50%"
>
</p>
2. 固定a2系数，对各车道的a1和a0拟合，这样能让车道线上下左右的移动，但这样发现车道线会相交。
左为四分点拟合，右为所有点拟合。
<p>
<img
src="./images/LanePolyA2Frozen.png"
alt="四分点拟合"
title="四分点拟合"
width="50%"

<img
src="./images/LanePolyA2Frozen-AllPoints.png"
alt="所有点拟合"
title="所有点拟合"
width="50%"
>
</p>
3. 上述两种情况发现，不能只让上下平移，也不能让随便平移，需要在最能够体现车道宽度的地方，垂直的平移一定距离才能最佳拟合。由于之前没有考虑这种想法，所以应急车道的计算也有一定错误，在x=0处与y轴的交点处，并不一定能够通过垂直等几何运算，计算出车道线的方程。从上述两种情况的拟合结果来看，也是不合理的。




## 应急车道计算原理
根据内外侧的lane的车道线方程，去向外推算两个应急车道的方程（都是指车道中线方程）<br>
首先比较除非应急车道外的2个边界车道方程（称为内外侧车道）的常数项，对于常数项大的那个lane，推算其相邻应急车道时，常数项+某一数值向上推演；对于常数项小的那个lane，推算其相邻应急车道时，常数项+某一数值向下推演。<br>
分别对于内外侧的车道方程：<br>
1. 计算车道线在x=0处的导数值，即车道线在y轴交点处的斜率k。<br>
2. 计算y轴交点的法线方程斜率-1/k。<br>
3. 计算（普通车道+应急车道）/2的车道宽度d，近似为边界车道和应急车道在y轴附近的垂直距离。<br>
4. 根据几何关系，推导出上述某一数值Δb = d / cosα，其中α为切线的切角（tanα=k），即有<br>
Δb = d * sqrt(1+k^2)<br>
5. 再去计算应急车道的截距，就ok了。<br>



# 代码实现逻辑
<p>
<img
src="./calibration_logic.png"
alt="标定过程逻辑"
title="标定过程逻辑"
width="100%"
>
</p>